<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    
    <script type="text/javascript" src="cordova.js"></script>

    <style type="text/css">
    #map_canvas {
      position: absolute;
      left:-50px;
      top: -50px;
      right: -50px;
      bottom: -50px;
    }
	.infos_livraisons{
		position:fixed;
		background:#444;
		width:100%;
		top:0;
		left:0;
		min-height:20px;
		color:#fff;
	}
    </style>
    <script >
    document.addEventListener("deviceready", function() 
	{
		// Get the current device location "without map"
		var option = {
			maximumAge: 10000,
			timeout: 10000,
			enableHighAccuracy: true // use GPS as much as possible
		};
		plugin.google.maps.LocationService.getMyLocation(option, function(location) 
		{
			// Create a map with the device location
			var mapDiv = document.getElementById('map_canvas');
			var map = plugin.google.maps.Map.getMap(mapDiv, 
			{
				'camera': 
				{
					target: location.latLng,
					zoom: 16
				}
			});

			map.addEventListener(plugin.google.maps.event.MAP_READY, function() 
			{
				// Add a marker
				var text = ["Current your location:\n",
				"latitude:" + location.latLng.lat.toFixed(3),
				"longitude:" + location.latLng.lng.toFixed(3),
				"speed:" + location.speed,
				"time:" + location.time,
				"bearing:" + location.bearing].join("\n");

				var marker = map.addMarker(
				{
					title: text,
					position: location.latLng
				}, function(marker) 
				{
				  marker.showInfoWindow();
				});
				
				retourneMaPosition();
				
				var data = [
					{
						position : {lng :  4.696981, lat :  44.37775 },
						title :  " Georgina P Blach Intermediate School ",
						'icon': { 'url': 'img/pointer_7.png', size: { width: 33, height: 45 } }
					},
					{
						position : {lng :  4.805528, lat :  43.949317 },
						title :  " Benner Junior High School ",
						'icon': { 'url': 'img/pointer_7.png', size: { width: 40, height: 54 } }
					}
				]
				// Add markers
				var baseArrayClass = new plugin.google.maps.BaseArrayClass(data);

				baseArrayClass.map(function(options, cb) 
				{
					// The variable "options" contains each element of the data.
					//
					// The variable "cb" is a callback function of iteration.
					map.addMarker(options, cb);

				}, function(markers) 
				{
					markers.on(plugin.google.maps.event.MARKER_CLICK, function() 
					{
						alert("je clique sur le marqueur");
						$(".infos_livraisons").hide();
					});
					// Set a camera position that includes all markers.
					var bounds = [];
					data.forEach(function(POI) 
					{
						bounds.push(POI.position);
					});

					map.moveCamera({
						target: bounds
					}, function() 
					{
						// After camera moves open the last marker.
						markers[markers.length - 1].showInfoWindow();
					});
				});
			});
		});
		function onSuccess(position) 
		{
			var lat = position.coords.latitude;//latitude actuelle
			var longi = position.coords.longitude;//longitude actuelle
		
			$.ajax({
				url : 'http://www.colisclub.fr/application/ajax.php',
				type : 'GET', // Le type de la requête HTTP, ici devenu POST
				data:'lat=' + lat +
					'&longi=' + longi,
				dataType : 'html',
				success: function (html) 
				{
					alert("position enregistrée");
				},
				error: function(resultat, statut, erreur) 
				{
					navigator.notification.alert("erreur", alertCallback, "Géolocalisation", "Fermer");
				}
			});		
		}

		// onError Callback receives a PositionError object
		function onError(error) {
			alert('code: '    + error.code    + '\n' +
				  'message: ' + error.message + '\n');
		}
		
		function alertCallback()
		{
			//pour l'alert de cordova (obligatoire d avoir une fonction mais rien a y faire perso :) )
		}
		
		function retourneMaPosition()
		{
			setTimeout(function()
			{
				navigator.geolocation.getCurrentPosition(onSuccess, onError);
				retourneMaPosition();
			}
			, 240000);
		}
	});
	
	
    </script>
</head>

<body>
	<h1>test</h1>

    <div id="map_canvas">
    </div>
	
	<input type="hidden" name="old_longitude">
	<input type="hidden" name="old_latitude">
	
	<div class="infos_livraisons">
		hey
	</div>
	
	<script type="text/javascript" src="jquery.js"></script>

</body>

</html>