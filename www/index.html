<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    
    <script type="text/javascript" src="cordova.js"></script>

    <style type="text/css">
    #map_canvas {
      position: absolute;
      left:-50px;
      top: -50px;
      right: -50px;
      bottom: -50px;
    }
    </style>
    <script >
    document.addEventListener("deviceready", function() 
	{
		// Get the current device location "without map"
		var option = {
			maximumAge: 3000,
			timeout: 5000,
			enableHighAccuracy: true // use GPS as much as possible
		};
		plugin.google.maps.LocationService.getMyLocation(option, function(location) 
		{
			// Create a map with the device location
			var mapDiv = document.getElementById('map_canvas');
			var map = plugin.google.maps.Map.getMap(mapDiv, 
			{
				'camera': 
				{
					target: location.latLng,
					zoom: 16
				}
			  });

			map.addEventListener(plugin.google.maps.event.MAP_READY, function() 
			{
				// Add a marker
				var text = ["Current your location:\n",
				"latitude:" + location.latLng.lat.toFixed(3),
				"longitude:" + location.latLng.lng.toFixed(3),
				"speed:" + location.speed,
				"time:" + location.time,
				"bearing:" + location.bearing].join("\n");

				var marker = map.addMarker(
				{
					title: text,
					position: location.latLng
				}, function(marker) 
				{
				  marker.showInfoWindow();
				});
			});
		});
		function onSuccess(position) 
		{
			var lat = position.coords.latitude;//latitude actuelle
			var longi = position.coords.longitude;//longitude actuelle
			
			var val_lat = $("input[name='old_latitude']").val(); //derniere latitude enregistrée
			var val_longi = $("input[name='old_longitude']").val();//derniere longitude enregistrée
			
			if(val_lat == '' && val_longi == '')
			{
				$("input[name='old_latitude']").val( lat );
				$("input[name='old_longitude']").val( longi );
				
				var launch_geo = true;
			}
			else
			{
				var old_lat = parseFloat( val_lat );
				var old_longi = parseFloat( val_longi );
				
				var launch_geo = false;
			}
			
			//pour avoir un nombre positif on verifie qui est superieur a qui
			if(old_lat >= lat)
			{
				var dif_lat = old_lat - lat; 
			}
			else
			{
				var dif_lat = lat - old_lat;
			}
			
			if(old_longi >= longi)
			{
				var dif_longi = old_longi - longi; 
			}
			else
			{
				var dif_longi = longi - old_longi;
			}
			
			alert("old_lat: " + old_lat + " - lat: " + lat + " - dif_lat: " + dif_lat + " | old_longi: " + old_longi + " - longi: " + longi + " - dif_longi: " + dif_longi);
			
			//si on a demarre juste l'appli (on a rien dans old_lat) ou si l ecart est > a 0.005 en longi ou en lati
			if(launch_geo == true || dif_lat >= 0.005 || dif_longi >= 0.005)
			{
				alert("on rentre dans la condition");
				$.ajax({
					url : 'http://www.colisclub.fr/application/ajax.php',
					type : 'GET', // Le type de la requête HTTP, ici devenu POST
					data:'lat=' + lat +
						'&longi=' + longi,
					dataType : 'html',
					success: function (html) 
					{
						$("input[name='old_longitude']").val(longi);
						$("input[name='old_latitude']").val(lat);
						alert("valeur longitude input old:" + $("input[name='old_longitude']").val() );
					},
					error: function(resultat, statut, erreur) 
					{
						navigator.notification.alert("erreur", alertCallback, "Géolocalisation", "Fermer");
					}
				});
			}	
		}

		// onError Callback receives a PositionError object
		function onError(error) {
			alert('code: '    + error.code    + '\n' +
				  'message: ' + error.message + '\n');
		}
		
		function alertCallback()
		{
			//pour l'alert de cordova (obligatoire d avoir une fonction mais rien a y faire perso :) )
		}

		// Options: throw an error if no update is received every 30 seconds.
		//
		var watchID = navigator.geolocation.watchPosition(onSuccess, onError, option);
		
	});
	
	
    </script>
</head>

<body>
	<h1>test</h1>

    <div id="map_canvas">
    </div>
	
	<input type="hidden" name="old_longitude">
	<input type="hidden" name="old_latitude">
	
	<script type="text/javascript" src="jquery.js"></script>

</body>

</html>